---
title: "Chapter 2: Causality"
subtitle: "Data Transformation with Tidyverse Functions"
author: "Sho Miyazaki"
institute: "Keio University"
date: "5/26/2022"
output: 
  beamer_presentation:
    slide_level: 2
    toc: true
    theme: "Madrid"
    colortheme: "beaver"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(width = 100)
library(knitr)
library(cowplot)
```

# Overview

## Data Transformation

```{r fig.show="hold", out.width="80%", fig.align='center', echo=FALSE}
ggdraw() + 
  draw_image("figure/data-science-explore.png") 
```
*Source: [R for Data Science](https://r4ds.had.co.nz/explore-intro.html)*

## Let's get started with Data
\small
```{r warning=FALSE, message=FALSE}
## load packages
library(tidyverse)
library(qss)
## load data
resume <- read_csv("data/resume.csv")
# check data 
resume
```

## Today's Goal
### Combine functions to get informative output
\small
```{r warning=FALSE, message=FALSE}
racial_gaps_by_sex <- resume %>%
  group_by(race, sex) %>% 
    # using two variables to group the data 
  summarize(callback = mean(call)) %>% 
    # the callback rate for each group 
  pivot_wider(names_from = race, 
                # reshaping the data
              values_from = callback) %>%
  mutate(race_gap = white - black)
```
\large

```{r echo=FALSE}
kable(racial_gaps_by_sex)
```

## Tools
```{r fig.show="hold", out.width="40%", fig.align='center',echo=FALSE}
ggdraw() + 
  draw_image("figure/tidyr_logo.png") 
ggdraw() + 
  draw_image("figure/dplyr_logo.png") 
```

## `dplyr` from `Tidyverse`

```{r fig.show="hold", out.width="80%", fig.align='center', echo=FALSE}
ggdraw() + 
  draw_image("figure/dplyr.png") 
```
*Source: [RStudio](https://www.rstudio.com/resources/webinars/tidyverse-visualization-manipulation-basics/)*

# Subset Data

## Extract Columns (`select`) 

- `select`: Return columns by name/number/etc.
```{r}
## Subset with sex and race columns
resume_sex_race <- resume %>% 
  select(sex, race)
resume_sex_race
```


## Extract Rows (`filter`)

- `filter`: Return rows by name/number/etc.

```{r}
## subset data with black names
resumeB <- resume %>% 
  filter(race == "black")
resumeB
```

## Combining Functions

```{r}
## subset data with white, male-sounding names
## Then, let's remove the first name
resumeWm_without_firstname <- resume %>% 
  filter(race == "white" & sex == "male") %>% 
  select(!firstname)
resumeWm_without_firstname
```

# Add New Variable
## Compute New Columns (`mutate`)

- `mutate`
- `case_when`

\scriptsize
```{r}
## create a factor variable that takes one of the four values
resume <- resume %>%
  mutate(type = case_when(race == "black" & sex == "female" ~ "BlackFemale",
                          race == "black" & sex == "male" ~ "BlackMale",
                          race == "white" & sex == "female" ~ "WhiteFemale",
                          race == "white" & sex == "male" ~ "WhiteMale",
                          TRUE ~ "Other"))
resume
```

# Summarize Data
## Compute Table Summaries (`summarise`)

\scriptsize

```{r}
## callback rate for black female names
Bf_callback <- resume %>% 
  filter(race == "black" & sex =="female") %>%
  summarize(callback_rate = mean(call, na.rm = TRUE))
Bf_callback
```
\tiny
```{r}
## callback rate for white female names
Wf_callback <- resume %>% 
  filter(race == "white" & sex == "female") %>%
  summarize(callback_rate = mean(call, na.rm = TRUE))
Wf_callback
```
\scriptsize
```{r}
## difference between white and black women
Wf_callback - Bf_callback
```

# Summary

## Overwhelmed? 
### Don't worry!
There are many resources you can use, and you don't have to memorize all the functions.

- QSS Textbook
  + Tidyverse Version is on `Perrusal`
- Cheetsheets
  + Search "`tidyverse cheetsheets`"
  + https://www.rstudio.com/resources/cheatsheets/
- Online Resources 
  + Google " `tidyverse add column error` "
  + official reference page, stackoverflow, RPubs, etc. 

## But more importantly...

### Teaching Team
We are here for you!

- During / after the in-class exercises
- Office hours 
- Perussal 

## Let's practice!
```{r fig.show="hold", out.width="80%", fig.align='center', echo=FALSE}
ggdraw() + 
  draw_image("figure/dplyr.png") 
```
*Source: [RStudio](https://www.rstudio.com/resources/webinars/tidyverse-visualization-manipulation-basics/)*
